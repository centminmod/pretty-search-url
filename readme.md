# Pretty Search Url Wordpress Plugin

This plugin allows Wordpress `?s=wordpress+cache` query strings to be redirected to pretty url format `/search/wordpress+cache/` which is a ncessary step to enable Wordpress Cache Enabler plugin's advanced Nginx caching configuration with Centmin Mod 123.09beta01 and higher's Wordpress auto installer's Cache Enabler setup as outlined [here](https://community.centminmod.com/threads/caching-search-results-with-standard-centminmod-install.20027/#post-85037).

# Install

You can upload contents of this repository to `wp-content/plugins/pretty-search-url` directory you manually create and actiavte plugin from within Wordpress Admin.

Or for [Centmin Mod LEMP stack Nginx users](https://centminmod.com), install from SSH command line - replacing domain variable `domain.com` with your domain name:

```
domain=domain.com
cd /home/nginx/domains/$domain/public/wp-content/plugins/
mkdir -p pretty-search-url
wget -O /home/nginx/domains/$domain/public/wp-content/plugins/pretty-search-url/pretty-search-url.php https://github.com/centminmod/pretty-search-url/raw/master/pretty-search-url.php
wget -O /home/nginx/domains/$domain/public/wp-content/plugins/pretty-search-url/index.html https://github.com/centminmod/pretty-search-url/raw/master/index.html
wget -O /home/nginx/domains/$domain/public/wp-content/plugins/pretty-search-url/readme.md https://github.com/centminmod/pretty-search-url/blob/master/readme.md
#wget -O /home/nginx/domains/$domain/public/wp-content/plugins/pretty-search-url/LICENSE https://github.com/centminmod/pretty-search-url/raw/master/LICENSE
chown -R nginx:nginx /home/nginx/domains/$domain/public/wp-content/plugins/pretty-search-url
ls -lah /home/nginx/domains/$domain/public/wp-content/plugins/pretty-search-url
cd /home/nginx/domains/$domain/public
wp plugin activate pretty-search-url
wp plugin status pretty-search-url
```

Activate plugin

```
domain=domain.com
cd /home/nginx/domains/$domain/public

wp plugin activate pretty-search-url  
Plugin 'pretty-search-url' activated.
Success: Activated 1 of 1 plugins.
```

Check Status of plugin

```
domain=domain.com
cd /home/nginx/domains/$domain/public

wp plugin status pretty-search-url
Plugin pretty-search-url details:
    Name: Pretty Search Url
    Status: Active
    Version: 0.1
    Author: George Liu
    Description: Redirect search to pretty /search/ urls
```

Deactivate plugin

```
domain=domain.com
cd /home/nginx/domains/$domain/public

wp plugin deactivate pretty-search-url
Plugin 'pretty-search-url' deactivated.
Success: Deactivated 1 of 1 plugins.
```

# Example Enabling Wordpress Search Caching With Cache Enabler

Wordpress Cache Enabler plugin's advanced Nginx caching configuration with Centmin Mod 123.09beta01 and higher's Wordpress auto installer's Cache Enabler setup as outlined [here](https://community.centminmod.com/threads/caching-search-results-with-standard-centminmod-install.20027/#post-85037) after installing the Pretty Search Url plugin and making the following changes to KeyCDN's Cache Enabler's `cache_enabler.class.php` file to remove `is_search()` cache exclusion:

```
diff -u cache_enabler.class.php-orig cache_enabler.class.php-removesearch 
--- cache_enabler.class.php-orig        2020-07-17 05:33:33.933006105 +0000
+++ cache_enabler.class.php-removesearch        2020-07-17 05:34:17.572342714 +0000
@@ -1407,7 +1407,7 @@
         }
 
         // conditional tags
-        if ( self::_is_index() OR is_search() OR is_404() OR is_feed() OR is_trackback() OR is_robots() OR is_preview() OR post_password_required() ) {
+        if ( self::_is_index() OR is_404() OR is_feed() OR is_trackback() OR is_robots() OR is_preview() OR post_password_required() ) {
             return true;
         }
```

Then in `/usr/local/nginx/conf/wpincludes/cache-enabler.domain.com/wpcacheenabler_cache-enabler.domain.com.conf` where domain of wordpress site = `cache-enabler.domain.com` is generated by centmin.sh menu option 22, reassigning $cache_uri with `/search/wordpres+cache` by changing parts of includes above the initial `set $cache_enabler_uri` to

```
    if ($args ~* s=(.*)) {
      set $cache_uri $request_uri;
      set $check_surl $cache_uri;
      set $cache_uri /search/$1;
    }
    add_header Check-Uri "$check_surl";
    add_header Set-Uri "$cache_uri";

    # default html file
    set $cache_enabler_uri '${custom_subdir}/wp-content/cache/cache-enabler/${http_host}${cache_uri}index.html';
```
So now returned header via `Set-Uri` is = `$cache_uri`

```
curl -IL http://cache-enabler.domain.com/?s=wordpress+cache
HTTP/1.1 200 OK
Date: Thu, 16 Jul 2020 15:07:02 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 25301
Last-Modified: Thu, 16 Jul 2020 14:41:58 GMT
Connection: keep-alive
Vary: Accept-Encoding
ETag: "5f106736-62d5"
Server: nginx centminmod
X-Powered-By: centminmod
X-Xss-Protection: 1; mode=block
X-Content-Type-Options: nosniff
Check-Uri: /?s=wordpress+cache
Set-Uri: /search/wordpress+cache/
Accept-Ranges: bytes
```
direct cached url access
```
curl -I http://cache-enabler.domain.com/search/worldpress+cache/
HTTP/1.1 200 OK
Date: Thu, 16 Jul 2020 15:08:23 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 19736
Last-Modified: Thu, 16 Jul 2020 15:07:54 GMT
Connection: keep-alive
Vary: Accept-Encoding
ETag: "5f106d4a-4d18"
Server: nginx centminmod
X-Powered-By: centminmod
X-Xss-Protection: 1; mode=block
X-Content-Type-Options: nosniff
Set-Uri: /search/worldpress+cache/
Accept-Ranges: bytes
```

### wrk-cmm with wordpress search cached

load test with my forked wrk
```
wrk-cmm -t4 -c50 -d20s --latency --breakout http://cache-enabler.domain.com/search/worldpress+cache/
Running 20s test @ http://cache-enabler.domain.com/search/worldpress+cache/
  4 threads and 50 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.01ms    4.16ms  99.65ms   97.01%
    Connect   159.21us   71.17us 288.00us   58.33%
    TTFB        1.00ms    4.16ms  99.64ms   97.01%
    TTLB       10.21us   32.01us  11.02ms   99.97%
    Req/Sec    23.94k     9.82k   45.89k    64.12%
  Latency Distribution
     50%  415.00us
     75%  603.00us
     90%    1.19ms
     99%   10.78ms
  1907359 requests in 20.04s, 35.79GB read
Requests/sec:  95189.83
Transfer/sec:      1.79GB
```
direct query search cached
```
wrk-cmm -t4 -c50 -d20s --latency --breakout http://cache-enabler.domain.com/?s=wordpress+cache             
Running 20s test @ http://cache-enabler.domain.com/?s=wordpress+cache
  4 threads and 50 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   738.15us    2.44ms 108.60ms   95.81%
    Connect   144.73us   69.16us 280.00us   60.42%
    TTFB      724.86us    2.44ms 108.58ms   95.81%
    TTLB       13.46us   58.63us  14.02ms   99.96%
    Req/Sec    26.26k     6.27k   39.64k    70.00%
  Latency Distribution
     50%  351.00us
     75%  546.00us
     90%    1.21ms
     99%    7.54ms
  2092164 requests in 20.03s, 50.16GB read
Requests/sec: 104448.19
Transfer/sec:      2.50GB
```
### wrk-cmm with wordpress search non-cached

compared to default without wordpress search cache
```
curl -IL http://cache-enabler.domain.com/?s=wordpress+cache                                                                                
HTTP/1.1 200 OK
Date: Thu, 16 Jul 2020 15:46:04 GMT
Content-Type: text/html; charset=UTF-8
Connection: keep-alive
Vary: Accept-Encoding
Link: <http://cache-enabler.domain.com/wp-json/>; rel="https://api.w.org/"
Server: nginx centminmod
X-Powered-By: centminmod
X-Xss-Protection: 1; mode=block
X-Content-Type-Options: nosniff
Check-Uri: /?s=wordpress+cache
Set-Uri: /?s=wordpress+cache
```
cached search at 95,189 OR 104,448 requests/sec versus non-cached search at 332 requests/sec
```
wrk-cmm -t4 -c50 -d20s --latency --breakout http://cache-enabler.domain.com/?s=wordpress+cache            
Running 20s test @ http://cache-enabler.domain.com/?s=wordpress+cache
  4 threads and 50 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   143.66ms   16.60ms 238.90ms   68.44%
    Connect   165.79us   83.37us 334.00us   56.25%
    TTFB      143.60ms   16.60ms 238.79ms   68.47%
    TTLB       63.16us   25.84us   1.19ms   85.77%
    Req/Sec    83.38     14.48   121.00     68.62%
  Latency Distribution
     50%  144.40ms
     75%  154.74ms
     90%  163.80ms
     99%  185.14ms
  6663 requests in 20.02s, 181.04MB read
Requests/sec:    332.85
Transfer/sec:      9.04MB
```